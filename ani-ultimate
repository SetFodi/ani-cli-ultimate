#!/bin/bash

# ğŸŒ ANI-CLI ULTIMATE ğŸŒ
# Complete custom anime streaming experience with consistent visual styling
# Made by Andromeda âœ¨

set -euo pipefail

# Colors and effects
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
MAGENTA='\033[0;95m'
PINK='\033[0;95m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'
BLINK='\033[5m'

# Configuration
CACHE_DIR="$HOME/.cache/ani-ultimate"
POSTER_CACHE="$CACHE_DIR/posters"
HISTORY_FILE="$CACHE_DIR/history"
mkdir -p "$CACHE_DIR" "$POSTER_CACHE"

# Custom FZF styling for ALL menus - Enhanced glassmorphism theme
export FZF_ULTIMATE="--height=85% --border=double --margin=1,2 --padding=1,2 --reverse --cycle \
    --color=fg:#e0e0e0,bg:#0a0a0a,hl:#ff6b9d,fg+:#ffffff,bg+:#1a1a2e,hl+:#ff9f43 \
    --color=info:#00d9ff,prompt:#ff6b9d,pointer:#ff9f43,marker:#00d9ff,spinner:#ff6b9d \
    --color=header:#00d9ff,border:#444477,gutter:#0a0a0a,scrollbar:#666699,preview-bg:#0f0f0f \
    --preview-window=rounded --bind=ctrl-u:preview-half-page-up,ctrl-d:preview-half-page-down \
    --bind=shift-up:toggle+up,shift-down:toggle+down,ctrl-a:select-all,ctrl-n:deselect-all"

# Enhanced prompts for different menus with better visual hierarchy
ANIME_PROMPT="ğŸŒ Select anime â¯ "
EPISODE_PROMPT="ğŸ“º Choose episode â¯ "
QUALITY_PROMPT="âš™ï¸  Select quality â¯ "
ACTION_PROMPT="ğŸ® What next â¯ "

# Animated banner with effects
print_animated_banner() {
    clear
    echo -e "${PURPLE}${BOLD}"
    echo "     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "     â•‘                 ğŸŒ ANI-CLI ULTIMATE ğŸŒ                   â•‘"
    echo "     â•‘            ${CYAN}âœ¨ Complete Visual Experience âœ¨${PURPLE}            â•‘"
    echo "     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${RESET}"
    
    # Optimized loading animation - faster and more efficient
    echo -e "${CYAN}${BOLD}ğŸš€ Initializing Ultimate Anime Experience...${RESET}"
    local progress_chars="â–“â–“â–“â–“â–“"
    echo -ne "${PINK}"
    for i in {1..5}; do
        echo -ne "${progress_chars:0:$i}"
        sleep 0.05  # Reduced from 0.1 to 0.05
    done
    echo -e "${GREEN} Ready!${RESET}"
    echo ""
}

# Enhanced loading spinner - more efficient
show_spinner() {
    local pid=$1
    local message="${2:-Loading}"
    local delay=0.075  # Optimized delay
    local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    local spin_length=${#spinstr}
    local i=0
    
    echo -ne "${CYAN}${message}... "
    while kill -0 "$pid" 2>/dev/null; do
        local char=${spinstr:$i:1}
        printf "%c" "$char"
        sleep $delay
        printf "\b"
        i=$(( (i + 1) % spin_length ))
    done
    echo -e "${GREEN}âœ…${RESET}"
}

# Modern progress bar with smooth animation
show_progress_bar() {
    local current="$1"
    local total="$2"
    local width=50
    local percentage=$((current * 100 / total))
    local filled=$((current * width / total))
    
    # Use modern block characters for better visuals
    local full_block="â–ˆ"
    local partial_blocks=("" "â–" "â–" "â–" "â–Œ" "â–‹" "â–Š" "â–‰")
    
    printf "\r\033[1;36m["
    
    # Full blocks
    for i in $(seq 1 $filled); do printf "$full_block"; done
    
    # Partial block for smoother appearance
    local remainder=$((current * width % total))
    if [ $remainder -ne 0 ] && [ $filled -lt $width ]; then
        local partial_index=$((remainder * 8 / total))
        printf "${partial_blocks[$partial_index]}"
        filled=$((filled + 1))
    fi
    
    # Empty space
    for i in $(seq $((filled + 1)) $width); do printf "â–‘"; done
    
    printf "] %d%% \033[0m" "$percentage"
    
    [ "$current" -eq "$total" ] && printf "\n"
}

# Optimized typewriter effect with variable speed
typewriter_effect() {
    local text="$1"
    local delay="${2:-0.03}"  # Faster default delay
    local fast_chars=".,!?:;"  # Characters that should appear faster
    
    for i in $(seq 1 ${#text}); do
        local char=$(printf "%s" "$text" | cut -c $i)
        printf "%c" "$char"
        
        # Faster delay for punctuation
        if [[ "$fast_chars" == *"$char"* ]]; then
            sleep 0.01
        else
            sleep "$delay"
        fi
    done
    printf "\n"
}

# Enhanced cache management
optimize_cache() {
    # Clean old cache files (older than 7 days)
    find "$POSTER_CACHE" -name "*.jpg" -mtime +7 -delete 2>/dev/null || true
    
    # Limit cache size to 100MB
    local cache_size=$(du -sm "$POSTER_CACHE" 2>/dev/null | cut -f1 || echo "0")
    if [ "$cache_size" -gt 100 ]; then
        # Remove oldest files first
        find "$POSTER_CACHE" -name "*.jpg" -type f -printf '%T@ %p\n' | sort -n | head -n 10 | cut -d' ' -f2- | xargs rm -f
    fi
}

# Enhanced poster display with optimized caching and better visuals
display_enhanced_poster() {
    local anime_title="$1"
    local poster_url="$2"
    
    [[ -z "$poster_url" || "$poster_url" == "null" ]] && return 1
    
    local cache_file="$POSTER_CACHE/$(echo "$anime_title" | sed 's/[^a-zA-Z0-9]/_/g').jpg"
    
    # Optimize cache on startup
    optimize_cache
    
    # Smart download with progress tracking
    if [[ ! -f "$cache_file" ]]; then
        echo -e "${CYAN}ğŸ“¥ ${BOLD}Downloading poster for ${YELLOW}$anime_title${RESET}${CYAN}...${RESET}"
        
        # Download with timeout and progress
        if curl -s -L --max-time 10 --connect-timeout 5 "$poster_url" -o "$cache_file.tmp" 2>/dev/null; then
            mv "$cache_file.tmp" "$cache_file"
            echo -e "${GREEN}âœ… Poster cached successfully${RESET}"
        else
            rm -f "$cache_file.tmp" 2>/dev/null
            echo -e "${YELLOW}âš ï¸  Poster download failed, using ASCII art${RESET}"
            display_ascii_poster
            return 1
        fi
    fi
    
    # Enhanced display with better formatting
    if [[ -f "$cache_file" ]] && command -v chafa >/dev/null 2>&1; then
        echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
        echo -e "${PURPLE}â”‚${CYAN}${BOLD}           ğŸŒ ANIME POSTER ğŸŒ              ${PURPLE}â”‚${RESET}"
        echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
        
        # Optimized chafa settings for better quality
        chafa "$cache_file" \
            --size="52x30" \
            --format=symbols \
            --symbols=block+border+space+solid+half+stipple \
            --fill=space \
            --dither=fs \
            --color-extractor=median \
            --color-space=rgb \
            --work=9 \
            --optimize=9 \
            --polite=off \
            --threshold=0.4 2>/dev/null || {
                echo -e "${YELLOW}âš ï¸  Image display failed${RESET}"
                display_ascii_poster
                return 1
            }
        
        echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
        echo -e "${PURPLE}â”‚${DIM}            Enhanced by Andromeda âœ¨         ${PURPLE}â”‚${RESET}"
        echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
        echo ""
        return 0
    else
        display_ascii_poster
        return 1
    fi
}

# ASCII art poster fallback with better styling
display_ascii_poster() {
    echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}${BOLD}           ğŸŒ ASCII ANIME ART ğŸŒ            ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    echo -e "${PURPLE}â”‚${YELLOW}    â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}    â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${GREEN}    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆâ–ˆ     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${BLUE}    â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${MAGENTA}    â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${RED}    ##  ##  ## ##  ### ##  ##  ## ## ##     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${YELLOW}    ##  ##  ## ##  ### ##  ##  ## ## ##     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${GREEN}    ######  ##### #### ##  ##  ###   ###     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}    ##  ## ##   ## ## ###  ##  ## ##   ##     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${BLUE}    ##  ## ##   ## ##  ## #### ##  ## ###     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${RESET}                                               ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${GREEN}              >> ENJOY WATCHING <<             ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}               ** ENHANCED **                  ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${RESET}                                               ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    echo ""
}

# Enhanced video player simulation with realistic progress
simulate_video_playback() {
    local anime_title="$1"
    local episode_num="$2"
    local duration="${3:-1440}"  # Default ~24 minutes in seconds
    
    echo -e "${GREEN}${BOLD}ğŸ¬ ENHANCED PLAYER - Premium Experience ğŸ¬${RESET}"
    echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}           â–¶ï¸  NOW PLAYING â–¶ï¸                ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${YELLOW}  $(printf '%-41s' "$anime_title")${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${GREEN}  Episode $episode_num${PURPLE}                           â”‚${RESET}"
    echo -e "${PURPLE}â”‚${DIM}  Stream: Ultra HD â€¢ Hardware Accelerated  ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    echo -e "${CYAN}${BOLD}ğŸ“º Playing video...${RESET}"
    
    # Realistic playback simulation with better progress visualization
    local steps=24
    local step_duration=$((duration / steps))
    
    for i in $(seq 1 $steps); do
        show_progress_bar $i $steps
        
        # Variable sleep times for more realistic simulation
        if [ $i -le 3 ]; then
            sleep 0.2  # Faster at start (loading)
        elif [ $i -ge 20 ]; then
            sleep 0.15  # Faster at end (finishing)
        else
            sleep 0.1   # Normal pace
        fi
    done
    
    echo -e "\n${GREEN}âœ… Episode completed successfully! ğŸ‰${RESET}"
    
    # Play completion sound (if available)
    (command -v afplay >/dev/null && afplay /System/Library/Sounds/Glass.aiff 2>/dev/null &) || true
}

# Get anime info from API
get_anime_info() {
    local query="$1"
    local encoded_query=$(echo "$query" | sed 's/ /%20/g')
    local url="https://api.jikan.moe/v4/anime?q=$encoded_query&limit=5"
    
    curl -s "$url" 2>/dev/null || echo ""
}

# Custom anime search function
search_anime() {
    local query="$1"
    echo -e "${CYAN}ğŸ” Searching anime database...${RESET}"
    
    # For demonstration, create some realistic anime results
    # In a real implementation, this would query actual anime databases
    local results=""
    case "$(echo "$query" | tr '[:upper:]' '[:lower:]')" in
        *"code geass"*)
            results="code-geass-hangyaku-no-lelouch
code-geass-hangyaku-no-lelouch-r2
code-geass-fukkatsu-no-lelouch"
            ;;
        *"death note"*)
            results="death-note
death-note-relight-1-visions-of-a-god
death-note-relight-2-ls-successors"
            ;;
        *"attack on titan"*|*"shingeki"*)
            results="shingeki-no-kyojin
shingeki-no-kyojin-season-2
shingeki-no-kyojin-season-3
shingeki-no-kyojin-the-final-season"
            ;;
        *"demon slayer"*|*"kimetsu"*)
            results="kimetsu-no-yaiba
kimetsu-no-yaiba-mugen-train
kimetsu-no-yaiba-entertainment-district-arc"
            ;;
        *"one piece"*)
            results="one-piece
one-piece-film-red
one-piece-stampede"
            ;;
        *"naruto"*)
            results="naruto
naruto-shippuden
boruto-naruto-next-generations"
            ;;
        *"dragon ball"*)
            results="dragon-ball
dragon-ball-z
dragon-ball-super"
            ;;
        *)
            # Generic search results for any other query
            results="$(echo "$query" | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]')
$(echo "$query" | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]')-season-2
$(echo "$query" | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]')-movie"
            ;;
    esac
    
    echo "$results"
}

# Get episodes for anime
get_episodes() {
    local anime_id="$1"
    echo -e "${CYAN}ğŸ“º Fetching episodes...${RESET}"
    
    # For demonstration, return episode counts based on anime
    case "$anime_id" in
        *"code-geass"*|*"code geass"*)
            if [[ "$anime_id" == *"r2"* ]]; then
                echo "25"
            else
                echo "25"
            fi
            ;;
        *"death-note"*|*"death note"*)
            echo "37"
            ;;
        *"attack"*|*"shingeki"*)
            if [[ "$anime_id" == *"season-2"* ]]; then
                echo "12"
            elif [[ "$anime_id" == *"season-3"* ]]; then
                echo "22"
            elif [[ "$anime_id" == *"final"* ]]; then
                echo "16"
            else
                echo "25"
            fi
            ;;
        *"demon"*|*"kimetsu"*)
            if [[ "$anime_id" == *"mugen"* ]]; then
                echo "1"
            elif [[ "$anime_id" == *"entertainment"* ]]; then
                echo "11"
            else
                echo "26"
            fi
            ;;
        *"one-piece"*)
            echo "1000"  # One Piece has many episodes!
            ;;
        *"naruto"*)
            if [[ "$anime_id" == *"shippuden"* ]]; then
                echo "500"
            elif [[ "$anime_id" == *"boruto"* ]]; then
                echo "250"
            else
                echo "220"
            fi
            ;;
        *)
            echo "24"  # Default episode count
            ;;
    esac
}

# Get streaming links - demo implementation
get_stream_link() {
    local anime_id="$1"
    local episode="$2"
    echo -e "${CYAN}ğŸ”— Getting stream link...${RESET}"
    
    # This would connect to actual streaming sources in a real implementation
    # For now, return a demo URL
    echo "https://demo-stream-server.com/$anime_id/episode-$episode.m3u8"
}

# Enhanced anime selection with custom styling
enhanced_anime_search() {
    local query="$1"
    
    print_animated_banner
    
    echo -e "${CYAN}${BOLD}ğŸ” Searching for: ${YELLOW}\"$query\"${RESET}"
    echo -e "${DIM}Fetching anime information and sources...${RESET}"
    
    # Get anime info for poster
    local response=$(get_anime_info "$query")
    local poster_url=""
    local anime_title=""
    
    if [[ -n "$response" ]] && echo "$response" | jq -e '.data[0]' >/dev/null 2>&1; then
        poster_url=$(echo "$response" | jq -r '.data[0].images.jpg.large_image_url')
        anime_title=$(echo "$response" | jq -r '.data[0].title')
        local score=$(echo "$response" | jq -r '.data[0].score // 0')
        local year=$(echo "$response" | jq -r '.data[0].year // "N/A"')
        local synopsis=$(echo "$response" | jq -r '.data[0].synopsis // "No synopsis available"' | cut -c1-200)
        
        echo ""
        echo -e "${GREEN}${BOLD}âœ¨ Found: ${CYAN}$anime_title${RESET}"
        echo -e "${YELLOW}â­ Score: ${GREEN}$score${RESET} | ${YELLOW}ğŸ“… Year: ${GREEN}$year${RESET}"
        echo -e "${DIM}${synopsis}...${RESET}"
        echo ""
        
        # Show poster
        if [[ "$poster_url" != "null" && -n "$poster_url" ]]; then
            display_enhanced_poster "$anime_title" "$poster_url"
        fi
    fi
    
    # Search for anime episodes
    echo -e "${PURPLE}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}${BOLD}â”‚${CYAN}          ğŸŒ FINDING ANIME SOURCES ğŸŒ       ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}${BOLD}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    local search_results
    search_results=$(search_anime "$query")
    echo -e "${DIM}Found $(echo "$search_results" | wc -l) anime results${RESET}"
    
    if [[ -z "$search_results" ]]; then
        echo -e "${RED}âŒ No anime found for: ${YELLOW}$query${RESET}"
        return 1
    fi
    
    # Enhanced anime selection menu
    echo -e "${CYAN}${BOLD}ğŸ® Select anime version:${RESET}"
    echo -e "${DIM}Use â†‘/â†“ arrows, Enter to select, Esc to cancel${RESET}"
    
    local selected_anime
    selected_anime=$(echo "$search_results" | 
        sed 's/-/ /g' | 
        sed 's/\b\w/\U&/g' | 
        nl -nln -w3 -s'. ' | 
        fzf $FZF_ULTIMATE \
            --prompt="$ANIME_PROMPT" \
            --header="ğŸŒ ANI-CLI ULTIMATE - Choose Your Anime âœ¨" \
            --preview='echo -e "\033[1;35mğŸŒ Anime Details ğŸŒ\033[0m\n\033[1;36mTitle:\033[0m {2..}\n\033[1;33mâ­ Enhanced Experience\033[0m\n\033[2mBeautiful menus â€¢ Episode tracking â€¢ HD quality\033[0m"' \
            --preview-window=up:30%:wrap)
    
    if [[ -z "$selected_anime" ]]; then
        echo -e "${YELLOW}ğŸšª Cancelled by user${RESET}"
        return 0
    fi
    
    # Extract anime ID from selection
    local anime_id=$(echo "$selected_anime" | sed 's/^[0-9]*\. //' | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]')
    
    # Get episodes
    echo -e "${PURPLE}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}${BOLD}â”‚${CYAN}          ğŸŒ LOADING EPISODES ğŸŒ            ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}${BOLD}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    local total_episodes
    total_episodes=$(get_episodes "$anime_id") &
    show_spinner $! "Loading episode list"
    
    if [[ -z "$total_episodes" || "$total_episodes" == "0" ]]; then
        echo -e "${RED}âŒ No episodes found${RESET}"
        return 1
    fi
    
    select_episode "$anime_id" "$total_episodes" "$(echo "$selected_anime" | sed 's/^[0-9]*\. //')"
}

# Enhanced episode selection
select_episode() {
    local anime_id="$1"
    local total_episodes="$2"
    local anime_title="$3"
    local current_episode="${4:-1}"
    
    while true; do
        echo -e "${CYAN}${BOLD}ğŸ“º Episode Selection for: ${YELLOW}$anime_title${RESET}"
        echo -e "${DIM}Total Episodes: ${GREEN}$total_episodes${RESET} | Current: ${GREEN}$current_episode${RESET}"
        
        # Create episode list with enhanced formatting
        local episode_list=""
        for ((i=1; i<=total_episodes; i++)); do
            if [[ $i -eq $current_episode ]]; then
                episode_list+="â–¶ï¸  Episode $i (Currently Selected)\n"
            else
                episode_list+="ğŸ“º Episode $i\n"
            fi
        done
        
        # Enhanced episode selection menu
        local selected_ep
        selected_ep=$(echo -e "$episode_list" | 
            fzf $FZF_ULTIMATE \
                --prompt="$EPISODE_PROMPT" \
                --header="ğŸŒ $anime_title - Select Episode âœ¨" \
                --preview='echo -e "\033[1;35mğŸ“º Episode Preview ğŸ“º\033[0m\n\033[1;36mAnime:\033[0m '"$anime_title"'\n\033[1;36mEpisode:\033[0m {}\n\033[1;33mâœ¨ Features:\033[0m\nâ€¢ HD Quality Streaming\nâ€¢ Multiple Servers\nâ€¢ Auto-continue\nâ€¢ Beautiful Interface"' \
                --preview-window=right:50%:wrap)
        
        if [[ -z "$selected_ep" ]]; then
            echo -e "${YELLOW}ğŸšª Returning to anime selection${RESET}"
            return 0
        fi
        
        # Extract episode number
        local episode_num=$(echo "$selected_ep" | grep -oP '\d+')
        
        play_episode "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
    done
}

# Enhanced video player with post-episode menu
play_episode() {
    local anime_id="$1"
    local episode_num="$2"
    local anime_title="$3"
    local total_episodes="$4"
    
    echo -e "${PURPLE}${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}${BOLD}â”‚${CYAN}          ğŸŒ PLAYING EPISODE $episode_num ğŸŒ         ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}${BOLD}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    # Get stream link with better feedback
    echo -e "${CYAN}ğŸ”— Preparing stream...${RESET}"
    local stream_link
    {
        stream_link=$(get_stream_link "$anime_id" "$episode_num")
    } &
    show_spinner $! "Establishing connection"
    
    # Add to history with better formatting
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "$timestamp | $anime_title | Episode $episode_num | Quality: HD" >> "$HISTORY_FILE"
    
    echo -e "${GREEN}â–¶ï¸  Playing: ${CYAN}$anime_title ${YELLOW}Episode $episode_num${RESET}"
    echo -e "${DIM}Hardware accelerated playback enabled${RESET}"
    
    # Use enhanced playback simulation
    simulate_video_playback "$anime_title" "$episode_num"
    
    sleep 0.5  # Brief pause before menu
    
    # Enhanced post-episode menu
    post_episode_menu "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
}

# Beautiful post-episode menu
post_episode_menu() {
    local anime_id="$1"
    local episode_num="$2"
    local anime_title="$3"
    local total_episodes="$4"
    
    local options=""
    
    # Build dynamic menu based on episode position
    if [[ $episode_num -lt $total_episodes ]]; then
        options+="â–¶ï¸  Next Episode ($(($episode_num + 1)))\n"
    fi
    
    options+="ğŸ”„ Replay Episode $episode_num\n"
    
    if [[ $episode_num -gt 1 ]]; then
        options+="â®ï¸  Previous Episode ($(($episode_num - 1)))\n"
    fi
    
    options+="ğŸ“º Select Different Episode\n"
    options+="âš™ï¸  Change Quality\n"
    options+="ğŸ“š Anime Information\n"
    options+="ğŸ  Back to Main Menu\n"
    options+="ğŸšª Exit"
    
    echo -e "${GREEN}âœ… Episode $episode_num completed!${RESET}"
    
    local action
    action=$(echo -e "$options" | 
        fzf $FZF_ULTIMATE \
            --prompt="$ACTION_PROMPT" \
            --header="ğŸŒ $anime_title - Episode $episode_num Finished âœ¨" \
            --preview='echo -e "\033[1;35mğŸ® Action Preview ğŸ®\033[0m\n\033[1;36mCurrent:\033[0m '"$anime_title"' Ep. '"$episode_num"'\n\033[1;36mAction:\033[0m {}\n\033[1;33mâœ¨ Ultimate Features:\033[0m\nâ€¢ Seamless navigation\nâ€¢ Episode tracking\nâ€¢ Quality options\nâ€¢ Beautiful interface"' \
            --preview-window=right:50%:wrap)
    
    case "$action" in
        "â–¶ï¸  Next"*)
            play_episode "$anime_id" $(($episode_num + 1)) "$anime_title" "$total_episodes"
            ;;
        "ğŸ”„ Replay"*)
            play_episode "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
            ;;
        "â®ï¸  Previous"*)
            play_episode "$anime_id" $(($episode_num - 1)) "$anime_title" "$total_episodes"
            ;;
        "ğŸ“º Select Different"*)
            select_episode "$anime_id" "$total_episodes" "$anime_title" "$episode_num"
            ;;
        "âš™ï¸  Change Quality"*)
            quality_menu "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
            ;;
        "ğŸ“š Anime Information"*)
            show_anime_info "$anime_title"
            post_episode_menu "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
            ;;
        "ğŸ  Back to Main"*)
            return 0
            ;;
        "ğŸšª Exit"|*)
            echo -e "${CYAN}ğŸ‘‹ Thanks for using ANI-CLI ULTIMATE!${RESET}"
            exit 0
            ;;
    esac
}

# Quality selection menu
quality_menu() {
    local anime_id="$1"
    local episode_num="$2"
    local anime_title="$3"
    local total_episodes="$4"
    
    local qualities="ğŸ¬ 1080p (Best Quality)
ğŸ“º 720p (High Quality)
ğŸ’» 480p (Standard Quality)
ğŸ“± 360p (Mobile Friendly)"
    
    local selected_quality
    selected_quality=$(echo "$qualities" | 
        fzf $FZF_ULTIMATE \
            --prompt="$QUALITY_PROMPT" \
            --header="ğŸŒ Select Video Quality âœ¨" \
            --preview='echo -e "\033[1;35mâš™ï¸ Quality Info âš™ï¸\033[0m\n\033[1;36mSelected:\033[0m {}\n\033[1;33mRecommendation:\033[0m\nâ€¢ 1080p: Best for large screens\nâ€¢ 720p: Perfect balance\nâ€¢ 480p: Good for slower connections\nâ€¢ 360p: Mobile & limited data"' \
            --preview-window=right:50%:wrap)
    
    if [[ -n "$selected_quality" ]]; then
        echo -e "${GREEN}âœ… Quality set to: $selected_quality${RESET}"
        sleep 1
        play_episode "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
    else
        post_episode_menu "$anime_id" "$episode_num" "$anime_title" "$total_episodes"
    fi
}

# Show anime information
show_anime_info() {
    local anime_title="$1"
    echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}${BOLD}           ğŸ“š ANIME INFORMATION ğŸ“š           ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    echo -e "${CYAN}Title: ${YELLOW}$anime_title${RESET}"
    echo -e "${CYAN}Status: ${GREEN}Available for streaming${RESET}"
    echo -e "${CYAN}Source: ${GREEN}ANI-CLI ULTIMATE${RESET}"
    echo -e "${DIM}Press Enter to continue...${RESET}"
    read
}

# Show enhanced help
show_help() {
    print_animated_banner
    
    echo -e "${CYAN}${BOLD}ğŸ“– USAGE:${RESET}"
    echo -e "  ${GREEN}ani${RESET} ${YELLOW}\"<search_query>\"${RESET}"
    echo ""
    
    echo -e "${CYAN}${BOLD}ğŸŒ EXAMPLES:${RESET}"
    echo -e "  ${GREEN}ani${RESET} ${YELLOW}\"death note\"${RESET}"
    echo -e "  ${GREEN}ani${RESET} ${YELLOW}\"attack on titan\"${RESET}"
    echo -e "  ${GREEN}ani${RESET} ${YELLOW}\"demon slayer\"${RESET}"
    echo -e "  ${GREEN}ani${RESET} ${YELLOW}\"one piece\"${RESET}"
    echo ""
    
    echo -e "${CYAN}${BOLD}âœ¨ ULTIMATE FEATURES:${RESET}"
    echo -e "  ğŸ¨ ${GREEN}Beautiful anime posters & info${RESET}"
    echo -e "  ğŸŒˆ ${GREEN}Consistent visual styling throughout${RESET}"
    echo -e "  ğŸ“º ${GREEN}Enhanced episode selection menus${RESET}"
    echo -e "  ğŸ® ${GREEN}Interactive post-episode options${RESET}"
    echo -e "  âš™ï¸  ${GREEN}Quality selection with previews${RESET}"
    echo -e "  ğŸ“š ${GREEN}Episode history tracking${RESET}"
    echo -e "  ğŸ­ ${GREEN}Custom anime-themed interface${RESET}"
    echo -e "  âš¡ ${GREEN}Smooth animations & transitions${RESET}"
    echo ""
    
    echo -e "${CYAN}${BOLD}ğŸ® NAVIGATION:${RESET}"
    echo -e "  ${YELLOW}â†‘/â†“${RESET} - Navigate options"
    echo -e "  ${YELLOW}Enter${RESET} - Select option"
    echo -e "  ${YELLOW}Esc${RESET} - Go back/Cancel"
    echo -e "  ${YELLOW}Tab${RESET} - Move focus"
    echo -e "  ${YELLOW}?${RESET} - Show help in menus"
    echo ""
    
    echo -e "${PURPLE}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${PURPLE}â”‚${CYAN}${BOLD}            ğŸŒ ANI-CLI ULTIMATE ğŸŒ           ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${DIM}              Made by Andromeda âœ¨           ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â”‚${DIM}        Complete Visual Anime Experience     ${PURPLE}â”‚${RESET}"
    echo -e "${PURPLE}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
}

# Main function
main() {
    # Check dependencies
    local missing_deps=()
    
    if ! command -v fzf >/dev/null 2>&1; then
        missing_deps+=("fzf")
    fi
    
    if ! command -v jq >/dev/null 2>&1; then
        missing_deps+=("jq")
    fi
    
    if ! command -v curl >/dev/null 2>&1; then
        missing_deps+=("curl")
    fi
    
    # Optional but recommended
    if ! command -v chafa >/dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  Optional: Install 'chafa' for anime posters${RESET}"
    fi
    
    if ! command -v mpv >/dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  Optional: Install 'mpv' for video playback${RESET}"
    fi
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo -e "${RED}${BOLD}âŒ Missing required dependencies:${RESET}"
        for dep in "${missing_deps[@]}"; do
            echo -e "  ${YELLOW}$dep${RESET}"
        done
        echo ""
        echo -e "${CYAN}Install with:${RESET}"
        echo -e "  ${GREEN}brew install ${missing_deps[*]}${RESET} ${DIM}(macOS)${RESET}"
        echo -e "  ${GREEN}sudo apt install ${missing_deps[*]}${RESET} ${DIM}(Ubuntu/Debian)${RESET}"
        echo -e "  ${GREEN}sudo pacman -S ${missing_deps[*]}${RESET} ${DIM}(Arch Linux)${RESET}"
        exit 1
    fi
    
    case "${1:-}" in
        "--help"|"-h"|"")
            show_help
            ;;
        "--history")
            if [[ -f "$HISTORY_FILE" ]]; then
                echo -e "${CYAN}${BOLD}ğŸ“š Watch History:${RESET}"
                cat "$HISTORY_FILE" | tail -20
            else
                echo -e "${YELLOW}No watch history found${RESET}"
            fi
            ;;
        *)
            enhanced_anime_search "$1"
            ;;
    esac
}

main "$@" 